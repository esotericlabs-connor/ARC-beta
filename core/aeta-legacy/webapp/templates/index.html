<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SentryMX Email Analyzer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}" />
  </head>
  <body>
    <header class="app-header">
      <h1>AETA Email Analyzer</h1>
      <p class="tagline">Predictive, community-informed assessments for your inbound messages.</p>
      <nav class="app-nav">
        <a href="/">Analyzer</a>
        <a href="{{ url_for('threat_intel') }}">Global Threat Intel</a>
      </nav>
    </header>

    <main>
      <section class="card upload-card">
        <form method="post" enctype="multipart/form-data" class="upload-form">
          <div class="field-group">
            <label for="eml_file">Email message (.eml)</label>
            <input type="file" id="eml_file" name="eml_file" accept=".eml" required />
          </div>
          <button type="submit" class="primary-button">Analyze message</button>
        </form>
        <p class="hint">All analysis runs locally. AETA Confidence ranges from 0 (high risk) to 100 (most legitimate).</p>
      </section>

      {% if error %}
        <section class="card alert alert-error">
          <strong>Upload error:</strong> {{ error }}
        </section>
      {% endif %}

      {% if report %}
        <section class="card report-summary">
          <header>
            <h2>Analysis summary</h2>
            <p class="filename">Source file: <strong>{{ report.filename }}</strong></p>
          </header>
          <div class="score-wrapper">
            <div class="score-value">{{ '%.2f'|format(report.score) }}</div>
            <div class="score-bar">
              <div class="score-bar-fill" style="width: {{ report.score_bar_width }}"></div>
            </div>
            <p class="verdict verdict-{{ report.verdict }}">Verdict: {{ report.verdict_label }}</p>
            <p class="risk-indicator">Aggregate risk: {{ '%.2f'|format(report.risk_score) }} (0 = low, 100 = high)</p>
          </div>
        </section>

        <section class="card">
          <h3>Authentication checks</h3>
          <table class="results-table">
            <thead>
              <tr>
                <th>Protocol</th>
                <th>Status</th>
                <th>Result</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for item in report.authentication %}
                <tr>
                  <td>{{ item.protocol }}</td>
                  <td><span class="status-pill {{ item.status_class }}">{{ item.status_label }}</span></td>
                  <td>{{ item.result }}</td>
                  <td class="details">{{ item.details or 'â€”' }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>

        <section class="card">
          <h3>Heuristic signal contributions</h3>
          <table class="results-table">
            <thead>
              <tr>
                <th>Signal</th>
                <th>Risk score</th>
                <th>Weight</th>
                <th>Weighted risk</th>
                <th>Details</th>
              </tr>
            </thead>
            <tbody>
              {% for contribution in report.contributions %}
                <tr>
                  <td>{{ contribution.name }}</td>
                  <td>{{ '%.2f'|format(contribution.risk_score) }}</td>
                  <td>{{ '%.2f'|format(contribution.weight) }}</td>
                  <td>{{ '%.2f'|format(contribution.weighted_risk) }}</td>
                  <td class="details">
                    <details>
                      <summary>View details</summary>
                      <pre>{{ contribution.details_json }}</pre>
                    </details>
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </section>

        <section class="card metadata">
          <h3>Email metadata</h3>
          {% if report.metadata %}
            <dl>
              {% for item in report.metadata %}
                <div>
                  <dt>{{ item.key }}</dt>
                  <dd>{{ item.value }}</dd>
                </div>
              {% endfor %}
            </dl>
          {% else %}
            <p>No metadata available.</p>
          {% endif %}
        </section>

        <section class="card">
          <h3>Raw report JSON</h3>
          <details class="json-details">
            <summary>Toggle raw JSON</summary>
            <pre class="json-block">{{ report.raw_json }}</pre>
          </details>
        </section>
      {% endif %}
    </main>

    <footer class="app-footer">
      <p>Run locally or containerise via Docker to inspect messages with AETA.</p>
    </footer>
  </body>
</html>